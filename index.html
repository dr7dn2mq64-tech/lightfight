<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LightFight</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; touch-action: none; }
        body { background: #000; overflow: hidden; width: 100vw; height: 100vh; font-family: 'Courier New', monospace; }
        #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        .hud { position: fixed; z-index: 10; pointer-events: none; }
        .hud-box { background: rgba(0,20,40,0.85); border: 1px solid #0ff; padding: 12px; color: #0ff; }
        .hud.left { top: 20px; left: 20px; }
        .hud.right { top: 20px; right: 20px; text-align: right; }
        .mode-indicator { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255,0,0,0.3); border: 1px solid #f00; color: #f00; padding: 5px 20px; font-size: 14px; z-index: 10; display: none; }
        
        #controls { position: fixed; bottom: 0; left: 0; width: 100%; height: 300px; z-index: 20; display: none; pointer-events: none; }
        #controls.active { display: block; }
        
        .stick { position: absolute; width: 140px; height: 140px; pointer-events: auto; touch-action: none; left: 30px; bottom: 40px; }
        .stick-base { width: 140px; height: 140px; background: rgba(0,255,255,0.15); border: 2px solid rgba(0,255,255,0.6); border-radius: 50%; position: absolute; }
        .stick-knob { width: 60px; height: 60px; background: rgba(0,255,255,0.9); border-radius: 50%; position: absolute; top: 40px; left: 40px; box-shadow: 0 0 15px #0ff; }
        
        .fire-btn { position: absolute; right: 30px; bottom: 90px; width: 100px; height: 100px; background: rgba(255,30,30,0.4); border: 3px solid #ff4444; border-radius: 50%; pointer-events: auto; color: #fff; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; z-index: 30; cursor: pointer; }
        .fire-btn:active, .fire-btn.active { background: rgba(255,30,30,0.7); transform: scale(0.95); }
        
        .action-btn { position: absolute; width: 65px; height: 65px; background: rgba(0,255,100,0.25); border: 2px solid #00ff66; border-radius: 50%; pointer-events: auto; color: #0f6; font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: center; z-index: 30; cursor: pointer; }
        .action-btn:active, .action-btn.active { background: rgba(0,255,100,0.5); transform: scale(0.95); }
        #jumpBtn { right: 150px; bottom: 150px; }
        #crouchBtn { right: 150px; bottom: 60px; font-size: 16px; }
        
        .center-menu { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; pointer-events: auto; z-index: 30; }
        .cbtn { background: rgba(0,0,0,0.7); border: 1px solid #0ff; color: #0ff; padding: 10px 20px; font-size: 12px; cursor: pointer; pointer-events: auto; }
        .cbtn:active { background: rgba(0,255,255,0.3); }
        
        .look-area { position: absolute; right: 0; top: 0; width: 50%; height: 100%; pointer-events: auto; z-index: 5; touch-action: none; }
        
        #mainMenu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center,#0a2436 0%,#000 100%); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 60px; overflow-y: auto; }
        .title { font-size: 3rem; color: #0ff; text-shadow: 0 0 30px #0ff; margin-bottom: 30px; font-weight: bold; letter-spacing: 4px; }
        
        .mode-card { background: rgba(0,40,60,0.6); border: 1px solid #0ff; padding: 15px; margin: 10px; width: 90%; max-width: 400px; cursor: pointer; transition: all 0.3s; pointer-events: auto; }
        .mode-card:active { background: rgba(0,255,255,0.2); transform: scale(0.98); }
        .mode-name { font-size: 1.4rem; color: #0ff; font-weight: bold; margin-bottom: 5px; }
        .mode-desc { font-size: 0.9rem; color: #8aa; line-height: 1.4; }
        .mode-rule { font-size: 0.8rem; color: #fd0; margin-top: 8px; border-top: 1px solid #044; padding-top: 5px; }
        
        #missionPanel { position: fixed; top: 80px; left: 20px; background: rgba(0,0,0,0.8); border-left: 3px solid #0ff; padding: 15px; color: #0ff; max-width: 250px; z-index: 15; display: none; pointer-events: none; }
        
        #creatorUI { position: fixed; top: 60px; right: 20px; display: none; flex-direction: column; gap: 10px; z-index: 30; pointer-events: auto; }
        .tool-btn { background: rgba(0,0,0,0.8); border: 1px solid #0ff; color: #0ff; padding: 10px 15px; font-size: 12px; cursor: pointer; pointer-events: auto; }
        .tool-btn.active { background: #0ff; color: #000; }
        
        .crosshair { position: fixed; top: 50%; left: 50%; width: 20px; height: 20px; border: 2px solid #0ff; border-radius: 50%; transform: translate(-50%,-50%); pointer-events: none; z-index: 20; }
        
        #hitmarker { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 40px; height: 40px; opacity: 0; pointer-events: none; z-index: 25; }
        #hitmarker.show { opacity: 1; animation: hit 0.2s forwards; }
        @keyframes hit { 0%{transform:translate(-50%,-50%) scale(0.5);} 50%{transform:translate(-50%,-50%) scale(1.2);} 100%{opacity:0;} }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>
<div class="crosshair"></div>
<svg id="hitmarker" viewBox="0 0 40 40">
    <line x1="5" y1="5" x2="15" y2="15" stroke="#fff" stroke-width="3"/>
    <line x1="35" y1="5" x2="25" y2="15" stroke="#fff" stroke-width="3"/>
    <line x1="5" y1="35" x2="15" y2="25" stroke="#fff" stroke-width="3"/>
    <line x1="35" y1="35" x2="25" y2="25" stroke="#fff" stroke-width="3"/>
</svg>

<div class="mode-indicator" id="modeIndicator">æ— å°½æ¨¡å¼ | æ³¢æ¬¡: 1</div>

<div id="missionPanel">
    <div style="font-weight:bold;margin-bottom:5px;color:#fff;">å½“å‰ä»»åŠ¡</div>
    <div style="font-size:0.9rem;color:#8aa;" id="missionObj">æ¶ˆç­æ‰€æœ‰æ•Œäºº</div>
</div>

<div class="hud left hud-box">
    <div style="font-size:20px;font-weight:bold;">HP: <span id="hp">100</span></div>
    <div style="margin-top:8px;color:#fd0;">ğŸ’° <span id="gold">0</span></div>
    <div style="font-size:13px;margin-top:8px;">å­å¼¹: <span id="ammo">30/90</span></div>
</div>
<div class="hud right hud-box">
    <div style="font-size:16px;font-weight:bold;color:#0ff;" id="weaponName">è‡ªåŠ¨æ­¥æª</div>
    <div style="font-size:12px;color:#888;margin-top:4px;" id="waveDisplay">WAVE 1</div>
</div>

<div id="controls">
    <div class="stick" id="moveStick">
        <div class="stick-base"></div>
        <div class="stick-knob" id="moveKnob"></div>
    </div>
    <div class="look-area" id="lookArea"></div>
    
    <div class="fire-btn" id="fireBtn">å¼€ç«</div>
    <div class="action-btn" id="jumpBtn">è·³</div>
    <div class="action-btn" id="crouchBtn">è¹²</div>
    
    <div class="center-menu">
        <button class="cbtn" onclick="game.pause()">||</button>
        <button class="cbtn" onclick="game.switchView()">è§†è§’</button>
        <button class="cbtn" onclick="game.reload()">æ¢å¼¹</button>
    </div>
</div>

<div id="creatorUI">
    <button class="tool-btn active" onclick="creator.setTool('enemy')" id="tool-enemy">+æ•Œäºº</button>
    <button class="tool-btn" onclick="creator.setTool('wall')" id="tool-wall">+å¢™ä½“</button>
    <button class="tool-btn" onclick="creator.setTool('spawn')" id="tool-spawn">å‡ºç”Ÿç‚¹</button>
    <button class="tool-btn" onclick="creator.test()" style="background:#0f0;color:#000;">æµ‹è¯•</button>
    <button class="tool-btn" onclick="game.exitToMenu()" style="background:#f00;color:#fff;">é€€å‡º</button>
</div>

<div id="mainMenu">
    <div class="title">LIGHTFIGHT</div>
    
    <div class="mode-card" onclick="game.start('story')">
        <div class="mode-name">ğŸ“– å‰§æƒ…æ¨¡å¼</div>
        <div class="mode-desc">æ·±å…¥LIGHTFIGHTä¸–ç•Œè§‚ï¼Œå®ŒæˆæŒ‡å®šä»»åŠ¡ç›®æ ‡</div>
        <div class="mode-rule">è§„åˆ™ï¼šä»»åŠ¡åˆ¶ | å…³å¡æ¨è¿› | å‰§æƒ…æ¼”å‡º</div>
    </div>
    
    <div class="mode-card" onclick="game.start('endless')">
        <div class="mode-name">â™¾ï¸ æ— å°½æ¨¡å¼</div>
        <div class="mode-desc">é¢å¯¹æ— é™æ¶Œæ¥çš„æ•Œäººï¼ŒæŒ‘æˆ˜æœ€é«˜ç”Ÿå­˜æ³¢æ¬¡</div>
        <div class="mode-rule">è§„åˆ™ï¼šæ— é™æ³¢æ¬¡ | éš¾åº¦é€’å¢ | ç§¯åˆ†æ’è¡Œ</div>
    </div>
    
    <div class="mode-card" onclick="game.start('survival')">
        <div class="mode-name">â˜ ï¸ ç”Ÿå­˜æŒ‘æˆ˜</div>
        <div class="mode-desc">ç‰©èµ„ç¨€ç¼ºï¼Œæ•Œäººå‡¶çŒ›ï¼Œåªæœ‰ä¸€æ¬¡ç”Ÿå‘½</div>
        <div class="mode-rule">è§„åˆ™ï¼šä¸€å‘½é€šå…³ | æ¯’åœˆæ”¶ç¼© | æœ‰é™å¼¹è¯</div>
    </div>
    
    <div class="mode-card" onclick="game.start('arena')">
        <div class="mode-name">âš”ï¸ ç«æŠ€åœº</div>
        <div class="mode-desc">ä¸ç²¾è‹±AIè¿›è¡Œ1v1å¯¹å†³ï¼Œæå‡æ’å</div>
        <div class="mode-rule">è§„åˆ™ï¼šBossæˆ˜ | é™å®šè£…å¤‡ | æ®µä½ç§¯åˆ†</div>
    </div>
    
    <div class="mode-card" onclick="game.start('creator')">
        <div class="mode-name">ğŸ› ï¸ é€ ç‰©ä¸»æ¨¡å¼</div>
        <div class="mode-desc">åˆ›é€ å±äºä½ çš„æˆ˜åœºï¼Œè‡ªå®šä¹‰åœ°å›¾ä¸è§„åˆ™</div>
        <div class="mode-rule">è§„åˆ™ï¼šè‡ªç”±å»ºé€  | å³æ—¶æµ‹è¯• | åˆ›æ„å·¥åŠ</div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
const Engine={
    scene:null,camera:null,renderer:null,
    player:null,weaponMesh:null,enemies:[],bullets:[],objects:[],
    
    init(){
        const canvas=document.getElementById('canvas');
        this.scene=new THREE.Scene();
        this.scene.background=new THREE.Color(0x051015);
        this.scene.fog=new THREE.Fog(0x051015,10,80);
        
        this.camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
        this.renderer=new THREE.WebGLRenderer({canvas:canvas,antialias:true});
        this.renderer.setSize(window.innerWidth,window.innerHeight);
        this.renderer.shadowMap.enabled=true;
        
        this.scene.add(new THREE.AmbientLight(0x6688aa,0.6));
        const dir=new THREE.DirectionalLight(0xffffff,0.9);
        dir.position.set(15,30,10);dir.castShadow=true;
        this.scene.add(dir);
        
        this.resetMap();
        
        this.player=new THREE.Group();
        this.player.position.set(0,1.6,0);
        
        const gun=new THREE.Mesh(
            new THREE.BoxGeometry(0.15,0.2,0.8),
            new THREE.MeshStandardMaterial({color:0x444444,metalness:0.8})
        );
        gun.position.set(0.4,0.2,0.4);
        this.weaponMesh=gun;
        this.player.add(gun);
        this.scene.add(this.player);
        
        window.addEventListener('resize',()=>{
            this.camera.aspect=window.innerWidth/window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.renderer.setSize(window.innerWidth,window.innerHeight);
        });
        
        this.animate();
    },
    
    resetMap(){
        this.objects.forEach(o=>this.scene.remove(o));
        this.objects=[];
        
        const floor=new THREE.Mesh(
            new THREE.PlaneGeometry(200,200),
            new THREE.MeshStandardMaterial({color:0x0a1a2a})
        );
        floor.rotation.x=-Math.PI/2;floor.receiveShadow=true;
        this.scene.add(floor);this.objects.push(floor);
        
        this.scene.add(new THREE.GridHelper(200,50,0x00ffff,0x003344));
        
        for(let i=0;i<20;i++){
            const h=2+Math.random()*6;
            const m=new THREE.Mesh(
                new THREE.BoxGeometry(3,h,3),
                new THREE.MeshLambertMaterial({color:[0xff0066,0x00ff88,0xffff00][i%3]})
            );
            m.position.set((Math.random()-0.5)*80,h/2,(Math.random()-0.5)*80);
            m.castShadow=true;this.scene.add(m);this.objects.push(m);
        }
    },
    
    spawnEnemy(pos){
        const mat=new THREE.MeshLambertMaterial({color:0xff0033});
        const geo=new THREE.BoxGeometry(0.8,1.8,0.8);
        const mesh=new THREE.Mesh(geo,mat);
        
        if(pos){
            mesh.position.copy(pos);
        }else{
            const angle=Math.random()*Math.PI*2,dist=15+Math.random()*20;
            mesh.position.set(
                this.player.position.x+Math.cos(angle)*dist,
                0.9,
                this.player.position.z+Math.sin(angle)*dist
            );
        }
        
        mesh.castShadow=true;
        this.scene.add(mesh);
        return {mesh:mesh,hp:100,maxHp:100,speed:0.03,dead:false};
    },
    
    createBullet(pos,dir){
        const b=new THREE.Mesh(
            new THREE.SphereGeometry(0.08),
            new THREE.MeshBasicMaterial({color:0xffff00})
        );
        b.position.copy(pos);
        this.scene.add(b);
        return {mesh:b,dir:dir,speed:1.5,life:60};
    },
    
    animate(){
        requestAnimationFrame(()=>this.animate());
        if(game.state==='playing' || game.state==='creator'){
            game.update();
            this.renderer.render(this.scene,this.camera);
        }
    }
};

const game={
    state:'menu',mode:'',wave:1,level:1,
    hp:100,maxHp:100,ammo:30,reserve:90,gold:0,
    move:{x:0,y:0},crouch:false,jumpVel:0,onGround:true,
    viewMode:0,score:0,time:0,
    storyProgress:0,endlessMultiplier:1,
    
    init(){
        Engine.init();
        this.bindButtons();
        this.setupControls();
        this.updateHUD();
    },
    
    bindButtons(){
        // Fire Button - åŒæ—¶æ”¯æŒç‚¹å‡»å’Œè§¦æ‘¸
        const fireBtn=document.getElementById('fireBtn');
        const handleFire=(e)=>{
            e.preventDefault();
            e.stopPropagation();
            if(this.mode==='creator')creator.place();
            else this.fire();
        };
        fireBtn.addEventListener('click',handleFire);
        fireBtn.addEventListener('touchstart',(e)=>{handleFire(e);fireBtn.classList.add('active');});
        fireBtn.addEventListener('touchend',()=>fireBtn.classList.remove('active'));
        
        // Jump Button
        const jumpBtn=document.getElementById('jumpBtn');
        const handleJump=(e)=>{
            e.preventDefault();e.stopPropagation();
            this.jump();
        };
        jumpBtn.addEventListener('click',handleJump);
        jumpBtn.addEventListener('touchstart',(e)=>{handleJump(e);jumpBtn.classList.add('active');});
        jumpBtn.addEventListener('touchend',()=>jumpBtn.classList.remove('active'));
        
        // Crouch Button
        const crouchBtn=document.getElementById('crouchBtn');
        const handleCrouch=(e)=>{
            e.preventDefault();e.stopPropagation();
            this.crouch=!this.crouch;
            crouchBtn.style.background=this.crouch?'rgba(0,255,100,0.6)':'rgba(0,255,100,0.25)';
        };
        crouchBtn.addEventListener('click',handleCrouch);
        crouchBtn.addEventListener('touchstart',(e)=>{handleCrouch(e);crouchBtn.classList.add('active');});
        crouchBtn.addEventListener('touchend',()=>crouchBtn.classList.remove('active'));
    },
    
    setupControls(){
        // Left Stick
        const stick=document.getElementById('moveStick');
        const knob=document.getElementById('moveKnob');
        let active=false,cx,cy;
        
        const updateStick=(touch)=>{
            const max=35;let dx=touch.clientX-cx,dy=touch.clientY-cy;
            const d=Math.sqrt(dx*dx+dy*dy);
            if(d>max){dx=(dx/d)*max;dy=(dy/d)*max;}
            knob.style.transform=`translate(${dx}px,${dy}px)`;
            this.move.x=dx/max;this.move.y=dy/max;
        };
        
        stick.addEventListener('touchstart',(e)=>{
            e.preventDefault();active=true;
            const r=stick.getBoundingClientRect();
            cx=r.left+70;cy=r.top+70;
            updateStick(e.touches[0]);
        },{passive:false});
        
        stick.addEventListener('touchmove',(e)=>{
            e.preventDefault();if(!active)return;
            for(let t of e.touches){
                if(Math.abs(t.clientX-cx)<70&&Math.abs(t.clientY-cy)<70){
                    updateStick(t);break;
                }
            }
        },{passive:false});
        
        const end=(e)=>{e.preventDefault();active=false;this.move.x=0;this.move.y=0;knob.style.transform='translate(0,0)';};
        stick.addEventListener('touchend',end,{passive:false});
        stick.addEventListener('touchcancel',end,{passive:false});
        
        // Look Area
        const lookArea=document.getElementById('lookArea');
        let lookTouch=null,lastX=0;
        
        lookArea.addEventListener('touchstart',(e)=>{
            for(let t of e.changedTouches){
                if(t.clientX>window.innerWidth/2&&!lookTouch){
                    lookTouch=t.identifier;lastX=t.clientX;
                }
            }
        },{passive:true});
        
        lookArea.addEventListener('touchmove',(e)=>{
            if(!lookTouch)return;
            for(let t of e.changedTouches){
                if(t.identifier===lookTouch){
                    const dx=t.clientX-lastX;
                    Engine.player.rotation.y-=dx*0.005;
                    lastX=t.clientX;e.preventDefault();
                }
            }
        },{passive:false});
        
        const endLook=(e)=>{
            for(let t of e.changedTouches)if(t.identifier===lookTouch)lookTouch=null;
        };
        lookArea.addEventListener('touchend',endLook,{passive:true});
        lookArea.addEventListener('touchcancel',endLook,{passive:true});
        
        // PC Controls
        this.keys={};
        document.addEventListener('keydown',(e)=>{
            this.keys[e.key.toLowerCase()]=true;
            if(e.code==='Space'||e.key===' ')this.jump();
            if(e.key==='c'||e.key==='C'){this.crouch=!this.crouch;document.getElementById('crouchBtn').style.background=this.crouch?'rgba(0,255,100,0.6)':'rgba(0,255,100,0.25)';}
            if(e.key==='r'||e.key==='R')this.reload();
            if(e.key==='v'||e.key==='V')this.switchView();
            if(e.key==='Escape')this.pause();
        });
        document.addEventListener('keyup',(e)=>this.keys[e.key.toLowerCase()]=false);
        
        document.addEventListener('mousedown',()=>{
            if(this.state==='playing'&&(!this.isMobile()))this.fire();
        });
        document.addEventListener('mousemove',(e)=>{
            if(this.state==='playing'&&document.pointerLockElement){
                Engine.player.rotation.y-=e.movementX*0.002;
            }
        });
        document.getElementById('canvas').addEventListener('click',()=>{
            if(this.state==='playing'&&!this.isMobile())document.getElementById('canvas').requestPointerLock();
        });
    },
    
    isMobile(){return'ontouchstart'in window||navigator.maxTouchPoints>0;},
    
    start(mode){
        this.mode=mode;this.state='playing';this.wave=1;this.level=1;
        this.hp=100;this.ammo=30;this.score=0;this.time=0;this.crouch=false;
        Engine.enemies.forEach(e=>Engine.scene.remove(e.mesh));Engine.enemies=[];
        Engine.bullets.forEach(b=>Engine.scene.remove(b.mesh));Engine.bullets=[];
        Engine.player.position.set(0,1.6,0);Engine.player.rotation.set(0,0,0);
        document.getElementById('crouchBtn').style.background='rgba(0,255,100,0.25)';
        
        document.getElementById('modeIndicator').style.display='block';
        document.getElementById('missionPanel').style.display='none';
        document.getElementById('creatorUI').style.display='none';
        document.getElementById('controls').classList.add('active');
        document.getElementById('mainMenu').style.display='none';
        
        switch(mode){
            case'story':
                this.storyProgress=0;
                document.getElementById('missionPanel').style.display='block';
                this.updateMission("ç¬¬ä¸€ç« ï¼šè§‰é†’","æ¶ˆç­å‰çº¿æœºå™¨äºº (0/3)");
                this.spawnStoryWave();
                break;
            case'endless':
                document.getElementById('modeIndicator').textContent='æ— å°½æ¨¡å¼ | æ³¢æ¬¡: 1';
                this.endlessMultiplier=1;
                this.spawnEndlessWave();
                break;
            case'survival':
                document.getElementById('modeIndicator').textContent='ç”Ÿå­˜æŒ‘æˆ˜ | æ¯’åœˆæ”¶ç¼©ä¸­';
                this.ammo=15;this.reserve=30;
                for(let i=0;i<5;i++)Engine.enemies.push(Engine.spawnEnemy());
                break;
            case'arena':
                document.getElementById('modeIndicator').textContent='ç«æŠ€åœº | BOSSæˆ˜';
                this.spawnArenaBoss();
                break;
            case'creator':
                this.state='creator';
                document.getElementById('creatorUI').style.display='flex';
                document.getElementById('modeIndicator').textContent='é€ ç‰©ä¸»æ¨¡å¼ | ç¼–è¾‘ä¸­';
                break;
        }
        this.updateHUD();
    },
    
    spawnStoryWave(){
        const count=3+this.level*2;
        for(let i=0;i<count;i++)Engine.enemies.push(Engine.spawnEnemy());
    },
    spawnEndlessWave(){
        const count=3+this.wave*2;
        this.endlessMultiplier=1+this.wave*0.2;
        for(let i=0;i<count;i++){
            const e=Engine.spawnEnemy();
            e.hp*=this.endlessMultiplier;
            e.speed*=Math.min(1.5,1+this.wave*0.05);
        }
    },
    spawnArenaBoss(){
        const e=Engine.spawnEnemy();
        e.hp=500;e.speed=0.08;e.mesh.scale.set(1.5,1.5,1.5);
        Engine.enemies.push(e);
    },
    
    update(){
        if(this.state!=='playing'&&this.state!=='creator')return;
        this.time++;
        
        const speed=this.crouch?0.06:0.12;
        const forward=new THREE.Vector3(0,0,-1).applyQuaternion(Engine.player.quaternion);
        const right=new THREE.Vector3(1,0,0).applyQuaternion(Engine.player.quaternion);
        
        let mx=0,my=0;
        if(this.keys){if(this.keys['w'])my++;if(this.keys['s'])my--;if(this.keys['a'])mx--;if(this.keys['d'])mx++;}
        if(this.move.x!==0||this.move.y!==0){mx=this.move.x;my=-this.move.y;}
        
        if(mx!==0||my!==0){
            const dir=forward.multiplyScalar(my).add(right.multiplyScalar(mx)).normalize();
            Engine.player.position.add(dir.multiplyScalar(speed));
        }
        
        if(this.jumpVel>0||!this.onGround){
            Engine.player.position.y+=this.jumpVel;this.jumpVel-=0.02;
            if(Engine.player.position.y<=1.6){
                Engine.player.position.y=1.6;this.jumpVel=0;this.onGround=true;
            }
        }
        
        if(this.viewMode===0){
            Engine.camera.position.copy(Engine.player.position);
            Engine.camera.position.y+=(this.crouch?-0.4:0);
            Engine.camera.rotation.order='YXZ';
            Engine.camera.rotation.y=Engine.player.rotation.y;
            Engine.weaponMesh.visible=true;
        }else{
            const off=new THREE.Vector3(0,2.5,-4).applyQuaternion(Engine.player.quaternion);
            Engine.camera.position.copy(Engine.player.position).add(off);
            Engine.camera.lookAt(Engine.player.position);
            Engine.weaponMesh.visible=false;
        }
        
        if(this.mode==='survival')this.updateSurvival();
        if(this.mode==='endless')this.updateEndless();
        
        for(let i=Engine.bullets.length-1;i>=0;i--){
            const b=Engine.bullets[i];
            b.mesh.position.add(b.dir.clone().multiplyScalar(b.speed));
            b.life--;
            let hit=false;
            for(let j=Engine.enemies.length-1;j>=0;j--){
                const e=Engine.enemies[j];
                if(e.dead)continue;
                if(b.mesh.position.distanceTo(e.mesh.position)<1.0){
                    hit=true;e.hp-=25;
                    document.getElementById('hitmarker').classList.add('show');
                    setTimeout(()=>document.getElementById('hitmarker').classList.remove('show'),200);
                    if(e.hp<=0){
                        e.dead=true;Engine.scene.remove(e.mesh);Engine.enemies.splice(j,1);
                        this.gold+=this.mode==='survival'?100:50;
                        this.onKill();
                    }
                    break;
                }
            }
            if(hit||b.life<=0){Engine.scene.remove(b.mesh);Engine.bullets.splice(i,1);}
        }
        
        const now=Date.now();
        Engine.enemies.forEach(e=>{
            if(e.dead)return;
            const dir=new THREE.Vector3().subVectors(Engine.player.position,e.mesh.position);
            const dist=dir.length();
            dir.y=0;dir.normalize();
            if(dist>1.2)e.mesh.position.add(dir.multiplyScalar(e.speed));
            e.mesh.lookAt(Engine.player.position);
            if(dist<1.8&&now-e.lastAttack>1000){
                this.takeDamage(this.mode==='survival'?20:10);e.lastAttack=now;
            }
        });
    },
    
    updateSurvival(){
        if(this.time%600===0){
            if(!this.survivalZone)this.survivalZone=100;
            this.survivalZone-=5;
            if(this.survivalZone<30)document.getElementById('modeIndicator').textContent='ç”Ÿå­˜æŒ‘æˆ˜ | âš ï¸ æ¯’åœˆé€¼è¿‘!';
        }
        if(this.survivalZone&&this.survivalZone<10)this.takeDamage(1);
    },
    updateEndless(){
        if(Engine.enemies.length===0){
            this.wave++;
            document.getElementById('modeIndicator').textContent=`æ— å°½æ¨¡å¼ | æ³¢æ¬¡: ${this.wave}`;
            this.spawnEndlessWave();
        }
    },
    onKill(){
        if(this.mode==='story'){
            this.storyProgress++;
            this.updateMission("ç¬¬ä¸€ç« ï¼šè§‰é†’",`æ¶ˆç­å‰çº¿æœºå™¨äºº (${this.storyProgress}/${3+this.level*2})`);
            if(this.storyProgress>=3+this.level*2&&Engine.enemies.length===0){
                this.level++;this.storyProgress=0;alert(`ä»»åŠ¡å®Œæˆ! è¿›å…¥ç¬¬${this.level}ç« `);
                this.spawnStoryWave();
            }
        }else if(this.mode==='arena'&&Engine.enemies.length===0){
            alert('èƒœåˆ©! +1000é‡‘å¸');
            this.gold+=1000;this.exitToMenu();
        }
    },
    
    jump(){
        if(this.onGround){
            this.jumpVel=0.4;this.onGround=false;
        }
    },
    fire(){
        if(this.mode==='creator'||this.ammo<=0){if(this.ammo<=0)this.reload();return;}
        this.ammo--;this.updateHUD();
        const pos=Engine.player.position.clone();
        const dir=new THREE.Vector3(0,0,-1).applyQuaternion(Engine.player.quaternion);
        Engine.bullets.push(Engine.createBullet(pos,dir));
        document.querySelector('.crosshair').style.transform='translate(-50%,-50%) scale(1.3)';
        setTimeout(()=>document.querySelector('.crosshair').style.transform='translate(-50%,-50%) scale(1)',50);
    },
    reload(){
        if(this.reserve>0){
            const need=30-this.ammo;
            const take=Math.min(need,this.reserve);
            this.ammo+=take;this.reserve-=take;
            this.updateHUD();
        }
    },
    switchView(){
        this.viewMode=(this.viewMode+1)%2;
        const names=['ç¬¬ä¸€äººç§°','ç¬¬ä¸‰äººç§°'];
        document.getElementById('weaponName').textContent=names[this.viewMode]+' Â· è‡ªåŠ¨æ­¥æª';
    },
    takeDamage(amt){
        this.hp-=amt;this.updateHUD();
        document.body.style.background='#300';
        setTimeout(()=>document.body.style.background='#000',100);
        if(this.hp<=0)this.gameOver(this.mode==='survival'?'åŒ–ä¸ºå°˜åŸƒ':`é˜µäº¡äºç¬¬${this.wave}æ³¢`);
    },
    gameOver(reason){
        alert(`æ¸¸æˆç»“æŸ\n${reason}\né‡‘å¸:${this.gold}\næ³¢æ¬¡:${this.wave}`);
        this.exitToMenu();
    },
    pause(){
        if(confirm('è¿”å›ä¸»èœå•?'))this.exitToMenu();
    },
    exitToMenu(){
        this.state='menu';this.mode='';
        document.getElementById('mainMenu').style.display='flex';
        document.getElementById('controls').classList.remove('active');
        document.getElementById('modeIndicator').style.display='none';
        document.getElementById('missionPanel').style.display='none';
        document.getElementById('creatorUI').style.display='none';
        Engine.enemies.forEach(e=>Engine.scene.remove(e.mesh));Engine.enemies=[];
    },
    updateMission(title,obj){
        document.getElementById('missionPanel').querySelector('div:first-child').textContent=title;
        document.getElementById('missionObj').textContent=obj;
    },
    updateHUD(){
        document.getElementById('hp').textContent=this.hp;
        document.getElementById('ammo').textContent=`${this.ammo}/${this.reserve}`;
        document.getElementById('gold').textContent=this.gold;
        document.getElementById('waveDisplay').textContent=this.mode==='endless'?`WAVE ${this.wave}`:this.mode.toUpperCase();
    }
};

const creator={
    tool:'enemy',
    setTool(t){
        this.tool=t;
        document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('tool-'+t).classList.add('active');
    },
    place(){
        const raycaster=new THREE.Raycaster();
        raycaster.setFromCamera(new THREE.Vector2(0,0),Engine.camera);
        const intersects=raycaster.intersectObjects(Engine.scene.children);
        if(intersects.length>0){
            const p=intersects[0].point;p.y=0.9;
            if(this.tool==='enemy')Engine.enemies.push(Engine.spawnEnemy(p));
            else if(this.tool==='wall'){
                const w=new THREE.Mesh(new THREE.BoxGeometry(4,4,4),new THREE.MeshLambertMaterial({color:0x888888}));
                w.position.copy(p);w.position.y=2;Engine.scene.add(w);Engine.objects.push(w);
            }
        }
    },
    test(){game.start('story');}
};

window.onload=()=>game.init();
</script>
</body>
</html>
